---
layout: post
title:  "redis"
date:   2020-12-13
categories: redis
tag: redis
---

* content
{:toc}

# Redis事务

Redis的单条命令是保证原子性的，但是redis事务不能保证原子性

> Redis 事务本质：一组命令的集合。
>
> 事务中每条命令都会被序列化，执行过程中按照顺序执行，不允许其他命令进行干扰。
>
> - 一次性
> - 循序性
> - 排他性
>
> 1. Redis事务没有隔离级别的概念
> 2. Redis单条命令是保证原子性的，但是事务不保证原子性

Redis 事务操作过程

- 开启事务（multi）
- 命令入队
- 执行事务（exec）

所有事务中的命令在加入时没有被执行，直到提交时才会开始执行（Exec）一次性完成

取消事务(discurd)

事务错误

> 代码语法错误（编译时异常）所有的命令都不执行



> 代码逻辑国务（运行时异常） **其他命令能正常执行，所以不保证事务的原子性**



监控

悲观锁：

- 很悲观，认为什么时候都会出现问题，无论做什么都会加锁

乐观锁：

- 很乐观，认为什么时候都不会出问题，所以不会上锁！更新数据的时候去判断一下，在此期间是否有人修改过这个数据
- 获取version
- 更新的时候比较version

使用 watch key 监控指定数据，相当于乐观锁加锁。

> 正常执行

> 测试多线程修改值，使用watch可以当做redis的乐观锁操作（相当于 getversion）

我们启动另外一个客户端模拟插入线程。